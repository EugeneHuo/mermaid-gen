<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Mermaid Diagram</title>
</head>
<body>
    <div class="mermaid">

flowchart TD
    subgraph Metadata
        title["Pipeline Name: json_to_tpuf_milo"]
        purpose["Purpose: Process JSON files and upload embeddings to Turbopuffer"]
        note["Owner: Milo Team"]
    end

    subgraph Step1_Ingestion
        A[" Type: JSON files<br/> Source: Config[BUCKET_NAME]<br/> Prefix: Config[PREFIX]"]
        B[" Latest file: Config[get_latest_file(project_id, bucket_name, prefix)]<br/> Document name: latest_json_file.name.replace(prefix, '').replace('.json', '')"]
    end

    subgraph Step2_Chunking
        C[" Method: RecursiveCharacterTextSplitter<br/> Size: 1000 tokens, Overlap: 50<br/> Splits by: Markdown headers"]
    end

    subgraph Step3_Embedding
        D[" Model: text-embedding-ada-002<br/> Service: OpenAI API<br/> Config: embedding_func(model=embedding_model_name, openai_api_key=Config[litellm-proxy-key-aia-milo])"]
        E[" Cache: Config[get_pickle_from_gcs(project_id, bucket_name, pkl_file_name)]<br/> File: embeddings.pkl"]
    end

    subgraph Step4_Storage
        F[" Vector DB: Turbopuffer<br/> Namespace: Config[namespace_name]<br/> Batch size: 15000"]
        G[" Firestore: Config[turbopuffer-client-id-firestore-collection]<br/> Document: namespace_name"]
    end

    subgraph Step5_Alerts
        H[" Webhook: Config[ALERT_WEBHOOK_URL]<br/> Log Table: Config[LOG_TABLE_ID]"]
    end

    title --> purpose
    title --> note
    A --> B
    B --> C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H

    </div>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</body>
</html>
